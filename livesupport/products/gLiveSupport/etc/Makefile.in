#-------------------------------------------------------------------------------
#   Copyright (c) 2004 Media Development Loan Fund
#
#   This file is part of the LiveSupport project.
#   http://livesupport.campware.org/
#   To report bugs, send an e-mail to bugs@campware.org
#
#   LiveSupport is free software; you can redistribute it and/or modify
#   it under the terms of the GNU General Public License as published by
#   the Free Software Foundation; either version 2 of the License, or
#   (at your option) any later version.
#
#   LiveSupport is distributed in the hope that it will be useful,
#   but WITHOUT ANY WARRANTY; without even the implied warranty of
#   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#   GNU General Public License for more details.
#
#   You should have received a copy of the GNU General Public License
#   along with LiveSupport; if not, write to the Free Software
#   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
#
#
#   Author   : $Author: fgerlits $
#   Version  : $Revision: 1.39 $
#   Location : $Source: /home/paul/cvs2svn-livesupport/newcvsrepo/livesupport/products/gLiveSupport/etc/Makefile.in,v $
#
#   @configure_input@
#-------------------------------------------------------------------------------

#-------------------------------------------------------------------------------
#   General command definitions
#-------------------------------------------------------------------------------
MKDIR   = mkdir -p
RM      = rm -f
RMDIR   = rm -rf
DOXYGEN = doxygen

#-------------------------------------------------------------------------------
#   Basic directory and file definitions
#-------------------------------------------------------------------------------
PACKAGE_NAME = @PACKAGE_NAME@

BASE_DIR     = @builddir@
DOC_DIR      = ${BASE_DIR}/doc
DOXYGEN_DIR  = ${DOC_DIR}/doxygen
COVERAGE_DIR = ${DOC_DIR}/coverage
BIN_DIR      = ${BASE_DIR}/bin
ETC_DIR      = ${BASE_DIR}/etc
SRC_DIR      = ${BASE_DIR}/src
TMP_DIR      = ${BASE_DIR}/tmp
VAR_DIR      = ${BASE_DIR}/var

USR_DIR         = ${BASE_DIR}/../../usr
USR_INCLUDE_DIR = ${USR_DIR}/include
USR_LIB_DIR     = ${USR_DIR}/lib
USR_BIN_DIR     = ${USR_DIR}/bin
BOOST_INCLUDE_DIR    = ${USR_INCLUDE_DIR}/boost-1_31

HELIX_LIB_DIR     = ${USR_LIB_DIR}/helix
HELIX_LIBS        = ${HELIX_LIB_DIR}/runtlib.a \
                    ${HELIX_LIB_DIR}/syslib.a \
                    ${HELIX_LIB_DIR}/contlib.a \
                    ${HELIX_LIB_DIR}/debuglib.a \
                    ${HELIX_LIB_DIR}/utillib.a 

GENRB     = ${USR_BIN_DIR}/genrb
GENRBOPTS = --destdir ${TMP_DIR} \
            --encoding utf-8 \
            --package-name ${PACKAGE_NAME} \
            --strict

VPATH    = ${SRC_DIR}

MODULES_DIR      = ${BASE_DIR}/../../modules
PRODUCTS_DIR     = ${BASE_DIR}/../../products

STORAGE_SERVER_DIR = ${MODULES_DIR}/storageServer

SCHEDULER_DIR    = ${PRODUCTS_DIR}/scheduler
SCHEDULER_EXE    = ${SCHEDULER_DIR}/tmp/scheduler

CORE_DIR         = ${MODULES_DIR}/core
CORE_INCLUDE_DIR = ${CORE_DIR}/include
CORE_LIB_DIR     = ${CORE_DIR}/lib
CORE_LIB         = livesupport_core
CORE_LIB_FILE    = ${CORE_LIB_DIR}/lib${CORE_LIB}.a

AUTHENTICATION_DIR         = ${MODULES_DIR}/authentication
AUTHENTICATION_INCLUDE_DIR = ${AUTHENTICATION_DIR}/include
AUTHENTICATION_LIB_DIR     = ${AUTHENTICATION_DIR}/lib
AUTHENTICATION_LIB         = livesupport_authentication
AUTHENTICATION_LIB_FILE   = ${AUTHENTICATION_LIB_DIR}/lib${AUTHENTICATION_LIB}.a

STORAGE_DIR         = ${MODULES_DIR}/storage
STORAGE_INCLUDE_DIR = ${STORAGE_DIR}/include
STORAGE_LIB_DIR     = ${STORAGE_DIR}/lib
STORAGE_LIB         = livesupport_storage
STORAGE_LIB_FILE    = ${STORAGE_LIB_DIR}/lib${STORAGE_LIB}.a

SCHEDULER_CLIENT_DIR         = ${MODULES_DIR}/schedulerClient
SCHEDULER_CLIENT_INCLUDE_DIR = ${SCHEDULER_CLIENT_DIR}/include
SCHEDULER_CLIENT_LIB_DIR     = ${SCHEDULER_CLIENT_DIR}/lib
SCHEDULER_CLIENT_LIB         = livesupport_scheduler_client
SCHEDULER_CLIENT_LIB_FILE = ${SCHEDULER_CLIENT_LIB_DIR}/lib${SCHEDULER_CLIENT_LIB}.a

PLAYLIST_EXECUTOR_DIR         = ${MODULES_DIR}/playlistExecutor
PLAYLIST_EXECUTOR_INCLUDE_DIR = ${PLAYLIST_EXECUTOR_DIR}/include
PLAYLIST_EXECUTOR_LIB_DIR     = ${PLAYLIST_EXECUTOR_DIR}/lib
PLAYLIST_EXECUTOR_LIB         = livesupport_playlist_executor
PLAYLIST_EXECUTOR_LIB_FILE    = ${PLAYLIST_EXECUTOR_LIB_DIR}/lib${PLAYLIST_EXECUTOR_LIB}.a

WIDGETS_DIR         = ${MODULES_DIR}/widgets
WIDGETS_INCLUDE_DIR = ${WIDGETS_DIR}/include
WIDGETS_LIB_DIR     = ${WIDGETS_DIR}/lib
WIDGETS_LIB         = livesupport_widgets
WIDGETS_LIB_FILE    = ${WIDGETS_LIB_DIR}/lib${WIDGETS_LIB}.a

LIBXMLPP_CFLAGS=@LIBXMLPP_CFLAGS@
LIBXMLPP_LIBS=@LIBXMLPP_LIBS@

CURL_LIBS=`${USR_DIR}/bin/curl-config --libs`

GTKMM_CFLAGS=@GTKMM_CFLAGS@
GTKMM_LIBS=@GTKMM_LIBS@

GSTREAMER_CFLAGS=@GSTREAMER_CFLAGS@
GSTREAMER_LIBS=@GSTREAMER_LIBS@

ICU_CFLAGS=
ICU_LIBS=`${USR_DIR}/bin/icu-config --ldflags-toolutil --ldflags-icuio`

TAGLIB_LIBS=`${USR_DIR}/bin/taglib-config --libs`

TEST_RESULTS = ${DOC_DIR}/testResults.xml
# the text result XSLT has to be relative to the test result file, e.g. TMP_DIR
TEST_XSLT    = ../etc/testResultToHtml.xsl

G_LIVESUPPORT_EXE = ${TMP_DIR}/gLiveSupport
G_LIVESUPPORT_SH  = ${BIN_DIR}/gLiveSupport_devenv.sh
G_LIVESUPPORT_CFG = ${ETC_DIR}/gLiveSupport.xml
TEST_RUNNER   = ${TMP_DIR}/testRunner

DOXYGEN_CONFIG = ${ETC_DIR}/doxygen.config

export LD_LIBRARY_PATH:=${LD_LIBRARY_PATH}:${USR_LIB_DIR}


#-------------------------------------------------------------------------------
#  	Configuration parameters
#-------------------------------------------------------------------------------
CPPFLAGS = @CPPFLAGS@
CXXFLAGS = @CXXFLAGS@ @DEFS@ @COVERAGE_CXXFLAGS@ -pthread \
                             -pedantic -Wall -Wno-long-long \
                             ${ICU_CFLAGS} \
                             ${LIBXMLPP_CFLAGS} \
                             ${GTKMM_CFLAGS} \
							 ${GSTREAMER_CFLAGS} \
                             -I${USR_INCLUDE_DIR} \
                             -I${BOOST_INCLUDE_DIR} \
                             -I${CORE_INCLUDE_DIR} \
                             -I${AUTHENTICATION_INCLUDE_DIR} \
                             -I${STORAGE_INCLUDE_DIR} \
                             -I${WIDGETS_INCLUDE_DIR} \
                             -I${SCHEDULER_CLIENT_INCLUDE_DIR} \
                             -I${PLAYLIST_EXECUTOR_INCLUDE_DIR} \
                             -I${TMP_DIR}
LDFLAGS  = @LDFLAGS@ -pthread \
                     ${ICU_LIBS} \
                     ${LIBXMLPP_LIBS} \
                     ${CURL_LIBS} \
                     ${GTKMM_LIBS} \
					 ${GSTREAMER_LIBS} \
                     ${TAGLIB_LIBS} \
                     -L${USR_LIB_DIR} \
                     -L${HELIX_LIB_DIR} \
                     -L${CORE_LIB_DIR} \
                     -L${AUTHENTICATION_LIB_DIR} \
                     -L${STORAGE_LIB_DIR} \
                     -L${WIDGETS_LIB_DIR} \
                     -L${SCHEDULER_CLIENT_LIB_DIR} \
                     -L${PLAYLIST_EXECUTOR_LIB_DIR}


#-------------------------------------------------------------------------------
#	Dependencies
#-------------------------------------------------------------------------------
G_LIVESUPPORT_OBJS = ${TMP_DIR}/GLiveSupport.o \
                     ${TMP_DIR}/MasterPanelWindow.o \
                     ${TMP_DIR}/NowPlaying.o \
                     ${TMP_DIR}/MasterPanelUserInfoWidget.o \
                     ${TMP_DIR}/LoginWindow.o \
                     ${TMP_DIR}/AudioClipListWindow.o \
                     ${TMP_DIR}/PlaylistListWindow.o \
                     ${TMP_DIR}/UploadFileWindow.o \
                     ${TMP_DIR}/ScratchpadWindow.o \
                     ${TMP_DIR}/SimplePlaylistManagementWindow.o \
                     ${TMP_DIR}/SchedulerWindow.o \
                     ${TMP_DIR}/SchedulePlaylistWindow.o \
                     ${TMP_DIR}/SearchWindow.o \
                     ${TMP_DIR}/AdvancedSearchEntry.o \
                     ${TMP_DIR}/AdvancedSearchItem.o \
                     ${TMP_DIR}/BrowseEntry.o \
                     ${TMP_DIR}/BrowseItem.o \
                     ${TMP_DIR}/LiveModeWindow.o \
                     ${TMP_DIR}/CuePlayer.o

G_LIVESUPPORT_RES = ${TMP_DIR}/${PACKAGE_NAME}_root.res \
                    ${TMP_DIR}/${PACKAGE_NAME}_en.res \
                    ${TMP_DIR}/${PACKAGE_NAME}_es.res \
                    ${TMP_DIR}/${PACKAGE_NAME}_hu.res \
                    ${TMP_DIR}/${PACKAGE_NAME}_sr.res

G_LIVESUPPORT_EXE_OBJS = ${TMP_DIR}/main.o

FSDF = ${G_LIVESUPPORT_OBJS} \
                         ${TMP_DIR}/main.o
G_LIVESUPPORT_EXE_LIBS = -l${PLAYLIST_EXECUTOR_LIB} \
                         -l${AUTHENTICATION_LIB} \
                         -l${STORAGE_LIB} \
                         -l${WIDGETS_LIB} \
                         -l${SCHEDULER_CLIENT_LIB} \
                         -l${CORE_LIB} \
                         ${HELIX_LIBS} \
                         -lboost_date_time-gcc \
                         -lxmlrpc++ -lssl

TEST_RUNNER_OBJS = ${G_LIVESUPPORT_OBJS} \
                   ${TMP_DIR}/AudioPlayerTest.o \
                   ${TMP_DIR}/TestRunner.o 
TEST_RUNNER_LIBS = ${G_LIVESUPPORT_EXE_LIBS} -lcppunit -ldl


#-------------------------------------------------------------------------------
#   Targets
#-------------------------------------------------------------------------------
.PHONY: all dir_setup doc clean docclean depclean distclean
.PHONY: install start run_tests stop uninstall

all: dir_setup ${G_LIVESUPPORT_EXE} ${G_LIVESUPPORT_RES} 

dir_setup: ${TMP_DIR} ${DOXYGEN_DIR}

doc:
	${DOXYGEN} ${DOXYGEN_CONFIG}

clean:
	${RM} ${G_LIVESUPPORT_EXE_OBJS} ${G_LIVESUPPORT_RES} ${G_LIVESUPPORT_EXE}
	${RM} ${TEST_RUNNER_OBJS} ${TEST_RUNNER}
	${RM} ${TMP_DIR}/*.bb ${TMP_DIR}/*.bbg ${TMP_DIR}/*.da ${TMP_DIR}/*.info

docclean:
	${RMDIR} ${DOXYGEN_DIR}/html
	${RMDIR} ${COVERAGE_DIR}/*
	${RM} ${TEST_RESULTS}

depclean: clean
	${MAKE} -C ${PLAYLIST_EXECUTOR_DIR} clean
	${MAKE} -C ${SCHEDULER_CLIENT_DIR} clean
	${MAKE} -C ${WIDGETS_DIR} clean
	${MAKE} -C ${STORAGE_DIR} clean
	${MAKE} -C ${AUTHENTICATION_DIR} clean
	${MAKE} -C ${CORE_DIR} clean

distclean: clean docclean
	${RMDIR} ${TMP_DIR}/config* ${TMP_DIR}/autom4te* ${TMP_DIR}/*.m4

check: all ${TEST_RUNNER} storage_server_init run_tests

run_tests: ${TEST_RUNNER}
	${TEST_RUNNER} -o ${TEST_RESULTS} -s ${TEST_XSLT}

run: all
	${G_LIVESUPPORT_SH}

install: ${SCHEDULER_EXE}
	-${MAKE} -C ${STORAGE_SERVER_DIR} db_init
	-${MAKE} -C ${SCHEDULER_DIR} install

start: ${SCHEDULER_EXE}
	${MAKE} -C ${SCHEDULER_DIR} start

stop: ${SCHEDULER_EXE}
	${MAKE} -C ${SCHEDULER_DIR} stop

status: ${SCHEDULER_EXE}
	${MAKE} -C ${SCHEDULER_DIR} status

uninstall: ${SCHEDULER_EXE}
	-${MAKE} -C ${SCHEDULER_DIR} uninstall
	-${MAKE} -C ${STORAGE_SERVER_DIR} db_clean

storage_server_init:
	${MAKE} -C ${STORAGE_SERVER_DIR}


#-------------------------------------------------------------------------------
#   Specific targets
#-------------------------------------------------------------------------------
${G_LIVESUPPORT_EXE}: ${CORE_LIB_FILE} \
                      ${AUTHENTICATION_LIB_FILE} \
                      ${STORAGE_LIB_FILE} \
                      ${WIDGETS_LIB_FILE} \
                      ${SCHEDULER_CLIENT_LIB_FILE} \
                      ${PLAYLIST_EXECUTOR_LIB_FILE} \
                      ${G_LIVESUPPORT_OBJS} ${G_LIVESUPPORT_EXE_OBJS}
	${CXX} ${LDFLAGS} -o $@ $^ ${G_LIVESUPPORT_EXE_LIBS}

${TMP_DIR}:
	${MKDIR} ${TMP_DIR}

${DOXYGEN_DIR}:
	${MKDIR} ${DOXYGEN_DIR}

${TEST_RUNNER}: ${CORE_LIB_FILE} \
                ${AUTHENTICATION_LIB_FILE} \
                ${STORAGE_LIB_FILE} \
                ${WIDGETS_LIB_FILE} \
                ${SCHEDULER_CLIENT_LIB_FILE} \
                ${TEST_RUNNER_OBJS}
	${CXX} ${LDFLAGS} -o $@ ${TEST_RUNNER_OBJS} ${TEST_RUNNER_LIBS}

${CORE_LIB_FILE}:
	${MAKE} -C ${CORE_DIR}

${AUTHENTICATION_LIB_FILE}:
	${MAKE} -C ${AUTHENTICATION_DIR}

${STORAGE_LIB_FILE}:
	${MAKE} -C ${STORAGE_DIR}

${WIDGETS_LIB_FILE}:
	${MAKE} -C ${WIDGETS_DIR}

${SCHEDULER_CLIENT_LIB_FILE}:
	${MAKE} -C ${SCHEDULER_CLIENT_DIR}

${PLAYLIST_EXECUTOR_LIB_FILE}:
	${MAKE} -C ${PLAYLIST_EXECUTOR_DIR}


#-------------------------------------------------------------------------------
#   Pattern rules
#-------------------------------------------------------------------------------
${TMP_DIR}/%.o : ${SRC_DIR}/%.cxx
	${CXX} ${CPPFLAGS} ${CXXFLAGS} -c -o $@ $<

${TMP_DIR}/${PACKAGE_NAME}_%.res : ${VAR_DIR}/%.txt
	${GENRB} ${GENRBOPTS} $^

